<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Buscar Pet por CPF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        input, button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
        }
        button {
            background: #6B456C;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #543657;
        }
        pre {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Teste de Busca de Pet por CPF</h1>
    
    <div class="test-section">
        <h2>1. Fazer Login como Veterinário</h2>
        <p>Primeiro, faça login como veterinário para ter autorização</p>
        <input type="email" id="email" placeholder="Email do veterinário" value="">
        <input type="password" id="senha" placeholder="Senha" value="senha123">
        <button onclick="fazerLogin()">Fazer Login</button>
        <pre id="resultLogin"></pre>
    </div>

    <div class="test-section">
        <h2>2. Buscar Pet por CPF</h2>
        <p>Digite o CPF do cliente (11 dígitos, sem pontos ou traços)</p>
        <input type="text" id="cpf" placeholder="CPF (11 dígitos)" maxlength="11" value="11122233344">
        <button onclick="buscarPet()">Buscar Pet</button>
        <pre id="resultBusca"></pre>
    </div>

    <div class="test-section">
        <h2>3. Verificar Clientes no Banco</h2>
        <p>Lista de CPFs cadastrados no sistema:</p>
        <ul>
            <li><strong>11122233344</strong> - Carlos Silva (Pet: Thor)</li>
        </ul>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let token = null;

        // Gerar email único para o vet
        const emailVet = localStorage.getItem('last_vet_email') || `vet${Math.floor(Math.random() * 10000)}@teste.com`;
        document.getElementById('email').value = emailVet;

        async function fazerLogin() {
            const result = document.getElementById('resultLogin');
            result.innerHTML = '<span class="info">Fazendo login...</span>';

            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('last_vet_email', email);

                    result.innerHTML = `<span class="success">✅ Login realizado!

Token: ${token.substring(0, 50)}...

Usuário: ${data.user.nome}
Tipo: ${data.user.tipo}

Agora você pode buscar pets por CPF!</span>`;
                } else {
                    result.innerHTML = `<span class="error">❌ Erro ao fazer login:
${JSON.stringify(data, null, 2)}

Dica: Se o veterinário não existe, cadastre um novo em: 
http://localhost:5000/cadastrovet.html</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">❌ Erro: ${error.message}</span>`;
            }
        }

        async function buscarPet() {
            const result = document.getElementById('resultBusca');
            const cpf = document.getElementById('cpf').value.trim();

            if (!token) {
                result.innerHTML = '<span class="error">❌ Faça login primeiro!</span>';
                return;
            }

            if (cpf.length !== 11 || !/^\d+$/.test(cpf)) {
                result.innerHTML = '<span class="error">❌ CPF deve conter exatamente 11 dígitos numéricos</span>';
                return;
            }

            result.innerHTML = `<span class="info">Buscando pet com CPF: ${cpf}...</span>`;

            try {
                const response = await fetch(`${API_URL}/buscar_pet_cpf/${cpf}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<span class="success">✅ Pet encontrado!

CPF do Cliente: ${cpf}

Dados do Pet:
${JSON.stringify(data, null, 2)}

---
Pet ID: ${data.id_pet}
Nome: ${data.nome_pet}
Raça: ${data.raca_pet}
Idade: ${data.idade} anos
Tutor: ${data.tutor_nome}
Email: ${data.tutor_email}
Telefone: ${data.tutor_telefone}
Observações: ${data.observacoes_pet}
</span>`;
                } else {
                    result.innerHTML = `<span class="error">❌ Erro ao buscar pet:
Status: ${response.status}

${JSON.stringify(data, null, 2)}

Possíveis causas:
1. CPF não cadastrado no sistema
2. Token expirado (faça login novamente)
3. Cliente não possui pet vinculado</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">❌ Erro: ${error.message}</span>`;
            }
        }

        // Auto-carregar token se já estiver logado
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
            token = savedToken;
            document.getElementById('resultLogin').innerHTML = '<span class="info">✅ Token encontrado no localStorage. Você já está logado!</span>';
        }
    </script>
</body>
</html>
